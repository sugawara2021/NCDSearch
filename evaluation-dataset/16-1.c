if (st == Z_BUF_ERROR && 
  (stream.avail_in || !stream.avail_out)) 
     break; 